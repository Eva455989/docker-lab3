name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:

  lint:
    name: Lint Dockerfile
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Hadolint
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile
        failure-threshold: error
        output-file: hadolint-report.txt
        
    - name: Upload Hadolint Report
      uses: actions/upload-artifact@v4

      with:
        name: hadolint-report
        path: hadolint-report.txt
        retention-days: 30


  build:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build Docker Image
      run: |
        docker build -t myapp:latest -t myapp:${{ github.sha }} .
        echo "Docker image built successfully!"
        
    - name: Test Docker Image
      run: |
        docker images | grep myapp
        
        docker run --rm -d --name test-container -p 8081:80 myapp:latest
        sleep 5
        
        # Проверяем что контейнер запущен
        docker ps | grep test-container
        
        # Тестируем веб-сервер
        docker exec test-container wget --spider localhost:80
        
        # Останавливаем тестовый контейнер
        docker stop test-container
        echo "Container test passed!"
        
    - name: Save Build Log
      run: |
        echo "Build completed: $(date)" > build-info.txt
        echo "Git SHA: ${{ github.sha }}" >> build-info.txt
        echo "Image: myapp:latest" >> build-info.txt
        docker images myapp >> build-info.txt
        
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4

      with:
        name: build-artifacts
        path: |
          build-info.txt
        retention-days: 30
